<#
.SYNOPSIS
    Creates/enables EnableCertPaddingCheck (DWORD=1) in both 64-bit and 
    32-bit WinTrust paths (the WOW6432Node path only on 64-bit OS). 
    It’s idempotent and verifies after setting.

.NOTES
    Author        : Joshua Schlegel
    Date Created  : 2025-08-27
    Last Modified : 2025-08-27
    Version       : 1.0

.TESTED ON
    Date(s) Tested  : 2025-08-27
    Tested By       : Joshua Schlegel
    Systems Tested  : Windows 10 Pro
    PowerShell Ver. : 5.1.17763.6189
    Wireshark Ver.  : 2.2.1 (v2.2.1-0-ga6fbd27 from master-2.2)

.USAGE
    Example syntax:
    PS C:\> .\CVE-2013-3900-WinVerifyTrust-SigValidation.ps1
#>

<#
EnableCertPaddingCheck for WinTrust (32/64-bit)
- HKLM\Software\Microsoft\Cryptography\Wintrust\Config\EnableCertPaddingCheck (DWORD 1)
- HKLM\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config\EnableCertPaddingCheck (DWORD 1) [64-bit OS only]
Run as Administrator.
#>

$Targets = @(
  'HKLM:\Software\Microsoft\Cryptography\Wintrust\Config'
)

# Add WOW6432Node path only if OS is 64-bit
if ([Environment]::Is64BitOperatingSystem) {
  $Targets += 'HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config'
}

function Require-Admin {
  $id = [Security.Principal.WindowsIdentity]::GetCurrent()
  $pr = New-Object Security.Principal.WindowsPrincipal($id)
  if (-not $pr.IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
    throw 'Please run PowerShell as Administrator.'
  }
}

function Ensure-RegistryValue([string]$Path, [string]$Name, [string]$Type, $Value) {
  if (-not (Test-Path $Path)) {
    New-Item -Path $Path -Force | Out-Null
  }
  if (-not (Get-ItemProperty -Path $Path -Name $Name -ErrorAction SilentlyContinue)) {
    New-ItemProperty -Path $Path -Name $Name -PropertyType $Type -Value $Value -Force | Out-Null
  } else {
    Set-ItemProperty -Path $Path -Name $Name -Value $Value -Force
  }
}

try {
  Require-Admin

  foreach ($p in $Targets) {
    Write-Host "Configuring: $p"
    Ensure-RegistryValue -Path $p -Name 'EnableCertPaddingCheck' -Type 'DWord' -Value 1

    $cur = (Get-ItemProperty -Path $p -Name 'EnableCertPaddingCheck' -ErrorAction Stop).EnableCertPaddingCheck
    Write-Host " -> EnableCertPaddingCheck = $cur"
  }

  Write-Host "✅ EnableCertPaddingCheck enabled (DWORD=1) in required paths."
  Write-Host "Note: You may need to restart apps/services that perform WinVerifyTrust for the change to take effect."

} catch {
  Write-Error $_.Exception.Message
}

---

<#
.SYNOPSIS
    Rollback Script

#>

'HKLM:\Software\Microsoft\Cryptography\Wintrust\Config',
'HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config' |
  ForEach-Object {
    if (Test-Path $_) { Set-ItemProperty -Path $_ -Name EnableCertPaddingCheck -Value 0 -ErrorAction SilentlyContinue }
  }

